const e="kids-points-static-v1",t="kids-points-api-v1",n="kids-points-offline-queue",s=["/","/index.html","/manifest.json","/nuqayah.png"];async function a(){const e=await caches.open(t),s=await e.match(n);if(s){return(await s.json()).queue||[]}return[]}async function i(e){const s=await caches.open(t),a=new Response(JSON.stringify({queue:e,updated:Date.now()}),{headers:{"Content-Type":"application/json"}});await s.put(n,a)}async function o(){if(!navigator.onLine)return;const e=await a();if(0===e.length)return;const t=[];for(const n of e)try{const e=new Request(n.url,{method:n.method,headers:n.headers,body:n.body});(await fetch(e)).ok&&(t.push(n.id),self.clients.matchAll().then(e=>{e.forEach(e=>{e.postMessage({type:"SYNC_SUCCESS",data:{request_id:n.id,url:n.url}})})}))}catch(e){console.error("Failed to sync request:",e);break}if(t.length>0){const n=e.filter(e=>!t.includes(e.id));await i(n),0===n.length&&self.clients.matchAll().then(e=>{e.forEach(e=>{e.postMessage({type:"SYNC_COMPLETE"})})})}}self.addEventListener("install",t=>{t.waitUntil(caches.open(e).then(e=>e.addAll(s)).then(()=>self.skipWaiting()))}),self.addEventListener("activate",n=>{const s=[e,t];n.waitUntil(caches.keys().then(e=>e.filter(e=>!s.includes(e))).then(e=>Promise.all(e.map(e=>caches.delete(e)))).then(()=>self.clients.claim()))}),self.addEventListener("online",e=>{e.waitUntil(o())}),self.addEventListener("fetch",n=>{const s=n.request;!function(e){return e.url.includes("/api/")}(s)?n.respondWith(caches.match(s).then(t=>t||fetch(s).then(t=>{if(t.ok&&!s.url.includes("chrome-extension://")){const n=t.clone();caches.open(e).then(e=>{e.put(s,n)})}return t})).catch(()=>"navigate"===s.mode?caches.match("/"):new Response("غير متاح",{status:503}))):!function(e){return["POST","PATCH","DELETE"].includes(e.method)}(s)?n.respondWith(fetch(s).then(e=>{if(e.ok){const n=e.clone();caches.open(t).then(e=>{e.put(s,n)})}return e}).catch(()=>caches.match(s).then(e=>e||new Response(JSON.stringify({offline:!0,message:"أنت غير متصل. هذه البيانات غير متاحة."}),{status:503,headers:{"Content-Type":"application/json"}})))):n.respondWith(fetch(s.clone()).catch(async e=>{if(!navigator.onLine){const e={url:s.url,method:s.method,headers:Object.fromEntries(s.headers.entries()),body:await s.clone().text()};return await async function(e){const t=await a();t.push({...e,id:Date.now()+Math.random(),timestamp:Date.now()}),await i(t)}(e),new Response(JSON.stringify({offline:!0,queued:!0,message:"تم حفظ العملية للمزامنة لاحقاً"}),{status:200,headers:{"Content-Type":"application/json"}})}throw e}))}),self.addEventListener("message",e=>{e.data&&"SYNC_OFFLINE_DATA"===e.data.type&&e.waitUntil(o())});